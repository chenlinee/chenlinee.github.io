---
title:  "使用qemu调试kernel"
search: true
categories:
  - kernel-dev
tags:
  - Linux
  - Kernel
toc: true
---

## 0.简介

qemu可以模拟各种架构的cpu、board, 也支持远程调试内核，使用qemu调试学习linux是
非常方便的。首先创建基于qemu/arm的调试虚拟环境，使用uboot作为bootloader，加载
linux内核，使用busybox构建根文件系统，提供内核和用户空间的基础运行环境。使用
qemu提供的arm virt系列Machine。

## 1.qemu源码编译

qemu源码：
  * archive: https://www.qemu.org/download/
  * git clone git://git.qemu-project.org/qemu.git

linux qemu编译：https://wiki.qemu.org/Hosts/Linux

```bash
#### requriment
sudo apt-get install build-essential
sudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build
# sudo apt-get install git-email
sudo apt-get install libaio-dev libbluetooth-dev libcapstone-dev libbrlapi-dev libbz2-dev
sudo apt-get install libcap-ng-dev libcurl4-gnutls-dev libgtk-3-dev
sudo apt-get install libibverbs-dev libjpeg8-dev libncurses5-dev libnuma-dev
sudo apt-get install librbd-dev librdmacm-dev
sudo apt-get install libsasl2-dev libsdl2-dev libseccomp-dev libsnappy-dev libssh-dev
sudo apt-get install libvde-dev libvdeplug-dev libvte-2.91-dev libxen-dev liblzo2-dev
sudo apt-get install valgrind xfslibs-dev
sudo apt-get install flex bison

#### build
# Switch to the QEMU root directory.
cd qemu
# Prepare a native debug build.
mkdir -p bin/debug/native
cd bin/debug/native
# Configure QEMU and start the build.
../../../configure --enable-debug
make -j$(nproc)
# Return to the QEMU root directory.
cd ../../..

# target
./bin/debug/native/aarch64-softmmu/qemu-system-aarch64 -M help
./bin/debug/native/aarch64-softmmu/qemu-system-aarch64 -cpu help
```

## 2.uboot编译运行

uboot源码：git clone https://github.com/u-boot/u-boot
x86 host交叉编译：
  * 编译文档：https://docs.u-boot.org/en/latest/build/index.html#
  * 针对qemu virt的部分编译文档：https://github.com/ARM-software/u-boot/blob/master/doc/README.qemu-arm

```bash
#### requriment
sudo apt-get install gcc gcc-aarch64-linux-gnu
sudo apt-get install bc bison build-essential coccinelle \
  device-tree-compiler dfu-util efitools flex gdisk graphviz imagemagick \
  liblz4-tool libgnutls28-dev libguestfs-tools libncurses-dev \
  libpython3-dev libsdl2-dev libssl-dev lz4 lzma lzma-alone openssl \
  pkg-config python3 python3-asteval python3-coverage python3-filelock \
  python3-pkg-resources python3-pycryptodome python3-pyelftools \
  python3-pytest python3-pytest-xdist python3-sphinxcontrib.apidoc \
  python3-sphinx-rtd-theme python3-subunit python3-testtools \
  python3-virtualenv swig uuid-dev

#### build
mkdir build
CROSS_COMPILE=aarch64-linux-gnu- make O=build qemu_arm64_defconfig
CROSS_COMPILE=aarch64-linux-gnu- make O=build -j$(nproc)
```

编译完成后，在u-boot源码目录得到u-boot.bin，加载到qemu即可运行。
```bash
./bin/debug/native/aarch64-softmmu/qemu-system-aarch64 \
    -M virt -cpu cortex-a57 \
    -bios ~/projects/u-boot/build/u-boot.bin
```

<figure style="width: 500px" class="align-center">
  <a href="/assets/images/2024.01.12-使用qemu调试kernel/sleep_and_wakeup.png"><img src="/assets/images/2021-11-28-Linux进程调度策略/sleep_and_wakeup.png"></a>
  <figcaption>图1. 休眠与唤醒</figcaption>
</figure>

